package org.planning.net.config;

import java.io.IOException;
import java.util.Properties;

import javax.sql.DataSource;

import org.seasar.doma.jdbc.DomaAbstractConfig;
import org.seasar.doma.jdbc.SimpleDataSource;
import org.seasar.doma.jdbc.dialect.Dialect;
import org.seasar.doma.jdbc.dialect.MssqlDialect;
import org.seasar.doma.jdbc.tx.LocalTransaction;
import org.seasar.doma.jdbc.tx.LocalTransactionalDataSource;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import javassist.bytecode.stackmap.TypeData.ClassName;

/**
 * Doma用コンフィグレーションクラスです。
 * <p>
 * Doma用にDataSourceおよびDialect（SQL方言を吸収するクラス)を保持します。
 * </p>
 *
 * @author quang-thien $Author: $
 * @version $Revision: $ $Date: $
 *
 */
@Component
public class AppConfig extends DomaAbstractConfig {

    private static final String JDBC_FILE = "datasource-cfg.properties";

    private static final String URL = "jdbc.sqlServer.url";

    private static final String USER = "jdbc.sqlServer.user";

    private static final String PASSWORD = "jdbc.sqlServer.password";

    private static final String DATABASE_NAME = "jdbc.sqlServer.databaseName";

    static {
        try {
            Class.forName("net.sourceforge.jtds.jdbc.Driver");
        } catch (ClassNotFoundException e) {
            throw new RuntimeException(e);
        }
    }

    @Autowired
    protected static final LocalTransactionalDataSource dataSource = createDataSource();

    @Autowired
    protected static final Dialect dialect = new MssqlDialect();

    @Override
    public DataSource getDataSource() {

        return dataSource;
    }

    @Override
    public Dialect getDialect() {

        return dialect;
    }

    protected static LocalTransactionalDataSource createDataSource() {

        Properties prop = new Properties();
        try {
            prop.load(ClassName.class.getClassLoader().getResourceAsStream(JDBC_FILE));
        } catch (IOException e) {
            e.printStackTrace();
        }
        String url = prop.getProperty(URL);
        String user = prop.getProperty(USER);
        String password = prop.getProperty(PASSWORD);
        String databaseName = prop.getProperty(DATABASE_NAME);

        String connection = url + ";" + "instance=" + databaseName;

        SimpleDataSource dataSource = new SimpleDataSource();
        dataSource.setUrl(connection);
        dataSource.setUser(user);
        dataSource.setPassword(password);
        return new LocalTransactionalDataSource(dataSource);
    }

    public static LocalTransaction getLocalTransaction() {

        return dataSource.getLocalTransaction(defaultJdbcLogger);
    }

    // TODO example
    // LocalTransaction tx = NaganoSqlServerDbConfig.getLocalTransaction();
    // tx.begin();
    //
    // SqlServerDao sqlServerDao = new SqlServerDaoimpl();
    // int csdc = sqlServerDao.selectCountTestSqlServer();
    // System.out.println(csdc);
    //
    // tx.commit();

}